<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deriv_Trade — Demo (All-in-one)</title>
<meta name="description" content="Deriv_Trade demo SPA. Login/Register, Home, Trade, Payments — single index.html. M-Pesa Till 3675058." />
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* ===== Theme variables ===== */
  :root{
    --bg: #000;
    --panel: #0d0d0f;
    --accent: #e30613;
    --muted: #bfbfbf;
    --glass: rgba(255,255,255,0.02);
    --success: #2bd17d;
    --danger: #ff5b5b;
    --radius: 12px;
    --maxw: 1200px;
  }

  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#000,#070707);color:#fff;-webkit-font-smoothing:antialiased;min-height:100vh}
  a{color:inherit}

  /* ===== Layout ===== */
  .wrap{max-width:var(--maxw);margin:18px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:3px solid var(--accent);background:linear-gradient(90deg,#070707,#0b0b0b);border-radius:8px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#9a0000);display:flex;align-items:center;justify-content:center;font-weight:900}
  .brand h1{margin:0;font-size:18px;color:var(--accent)}
  nav{display:flex;gap:8px;align-items:center}
  .tabbtn{background:transparent;border:none;padding:8px 12px;border-radius:8px;color:#fff;font-weight:700;cursor:pointer}
  .tabbtn.active{background:rgba(227,6,19,0.09);border-left:3px solid var(--accent);padding-left:14px}
  .small{color:var(--muted);font-size:13px}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:800}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .btn.red{background:#c40013}
  .top-right{display:flex;gap:8px;align-items:center}

  /* ===== Main area ===== */
  .main-grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
  @media(max-width:980px){ .main-grid{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start;gap:10px} .top-right{width:100%;justify-content:flex-end} }

  /* ===== Panels ===== */
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), var(--glass));padding:14px;border-radius:var(--radius);border:1px solid #151515}
  .card{background:var(--panel);padding:12px;border-radius:10px;border:1px solid #121212}

  /* ===== Login area ===== */
  .auth-wrap{display:flex;gap:24px;align-items:stretch;justify-content:center;margin-top:30px}
  .auth-left{flex:1;min-width:260px}
  .auth-right{width:420px}
  .tab{display:flex;gap:8px;margin-bottom:12px}
  .input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:#080808;color:#fff}
  .auth-note{background:#0a0a0a;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}
  .center{display:flex;align-items:center;justify-content:center}

  /* ===== Trade layout ===== */
  .chart-wrap{height:400px;border-radius:10px;padding:8px;background:#060606;border:1px solid #111}
  .controls{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .orders{max-height:280px;overflow:auto;margin-top:12px}
  .order{padding:10px;border-radius:8px;background:#0b0b0b;border-left:4px solid rgba(227,6,19,0.9);margin-bottom:8px;display:flex;justify-content:space-between;gap:8px}
  .muted{color:var(--muted)}

  /* ===== Payments ===== */
  .pay-icons{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px}
  .pay-icon{width:64px;height:64px;background:#fff;padding:6px;border-radius:8px;display:flex;align-items:center;justify-content:center;filter:grayscale(1) contrast(0.9) brightness(0.8)}
  .pay-note{font-size:14px;color:var(--muted);margin-top:8px}

  /* ===== Alerts ===== */
  .alerts{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:999}
  .alert{padding:10px 12px;border-radius:8px;background:#111;border-left:4px solid var(--accent);min-width:220px;box-shadow:0 12px 40px rgba(0,0,0,0.6)}

  /* ===== Footer ===== */
  footer{margin-top:22px;padding:12px;text-align:center;color:var(--muted)}

  /* small */
  .xs{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">

    <!-- HEADER -->
    <header>
      <div class="brand">
        <div class="logo">DT</div>
        <div>
          <h1>Deriv_Trade</h1>
          <div class="small">Black & Red • Demo Trading</div>
        </div>
      </div>

      <div class="top-right">
        <nav id="mainNav" style="display:flex;gap:6px;align-items:center">
          <button class="tabbtn" data-page="home" onclick="showPage('home')">Home</button>
          <button class="tabbtn" data-page="trade" onclick="showPage('trade')">Trade</button>
          <button class="tabbtn" data-page="payments" onclick="showPage('payments')">Payments</button>
        </nav>

        <div id="userControls" style="display:flex;gap:8px;align-items:center;margin-left:12px">
          <div class="xs" id="welcomeUser"></div>
          <button class="btn ghost" id="logoutBtn" onclick="logout()" style="display:none">Logout</button>
        </div>
      </div>
    </header>

    <!-- AUTH GATE: Login / Register (shows when not logged) -->
    <div id="authArea" style="margin-top:18px"></div>

    <!-- APP CONTENT -->
    <main id="appArea" style="display:none;margin-top:18px">
      <div id="home" class="panel" style="display:none">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
          <div>
            <h2 style="color:var(--accent);margin:0">Welcome to Deriv_Trade</h2>
            <div class="muted">Demo environment. Practice trading risk-free.</div>
          </div>
          <div>
            <button class="btn" onclick="showPage('trade')">Open Trade</button>
            <button class="btn ghost" onclick="showPage('payments')">Deposit</button>
          </div>
        </div>

        <div style="display:flex;gap:16px;margin-top:16px;flex-wrap:wrap">
          <div class="card" style="flex:1;min-width:260px">
            <div style="font-weight:800">M-Pesa Till</div>
            <div style="color:var(--accent);font-weight:900;font-size:20px">3675058</div>
            <div class="muted" style="margin-top:6px">After payment send transaction ID via WhatsApp</div>
          </div>

          <div class="card" style="flex:2;min-width:280px">
            <h3 style="color:var(--accent);margin:0">Features</h3>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
              <div class="card muted" style="min-width:160px">Demo Trading Engine</div>
              <div class="card muted" style="min-width:160px">Simulated Live Chart</div>
              <div class="card muted" style="min-width:160px">Easy Payments</div>
            </div>
          </div>
        </div>
      </div>

      <div id="trade" style="display:none">
        <div class="main-grid">
          <!-- CENTER -->
          <section>
            <div class="panel">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div id="assetTitle" style="font-weight:800">EUR/USD</div>
                  <div class="xs muted">Forex • Major</div>
                </div>
                <div class="xs">Spread: <strong id="spread">0.8</strong></div>
              </div>

              <div class="chart-wrap" style="margin-top:12px">
                <canvas id="chartCanvas"></canvas>
              </div>

              <div class="controls">
                <select id="assetSelect" class="input" onchange="changeAsset(this.value)">
                  <option value="EURUSD">EUR/USD</option>
                  <option value="GBPUSD">GBP/USD</option>
                  <option value="BTCUSD">BTC/USD</option>
                  <option value="XAUUSD">XAU/USD</option>
                  <option value="USDJPY">USD/JPY</option>
                </select>

                <input id="tradeSize" class="input" type="number" value="1" min="0.01" step="0.01" style="width:110px" />
                <select id="tradeLev" class="input" style="width:110px">
                  <option>10</option><option>25</option><option selected>50</option><option>100</option>
                </select>

                <button class="btn" onclick="quickOrder('buy')">Buy</button>
                <button class="btn sell" onclick="quickOrder('sell')">Sell</button>

                <div style="margin-left:auto" class="muted xs">Demo: local only</div>
              </div>

              <div class="orders" id="ordersList"></div>
            </div>

            <div class="panel" style="margin-top:12px">
              <h4 style="color:var(--accent);margin:0">Signals (demo)</h4>
              <div class="muted xs" style="margin-top:8px">Educational signals only.</div>
              <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
                <div class="card" style="min-width:200px">BUY EUR/USD • TP 1.0990 • SL 1.0790</div>
                <div class="card" style="min-width:200px">SELL XAU/USD • TP 2280 • SL 2330</div>
              </div>
            </div>

          </section>

          <!-- RIGHT -->
          <aside>
            <div class="panel">
              <h4 style="margin:0;color:var(--accent)">Trade Panel</h4>
              <div class="xs muted" style="margin-top:8px">Place demo orders — execution simulated</div>

              <div style="margin-top:12px">
                <div class="xs muted">Selected</div>
                <div style="font-weight:900" id="panelAsset">EUR/USD</div>

                <label class="xs muted" style="margin-top:8px">Size</label>
                <input id="panelSize" class="input" type="number" value="1" step="0.01" />

                <label class="xs muted" style="margin-top:8px">Leverage</label>
                <select id="panelLev" class="input">
                  <option>10</option><option>25</option><option selected>50</option><option>100</option>
                </select>

                <div style="display:flex;gap:8px;margin-top:10px">
                  <button class="btn" onclick="placeTrade('buy')">Place Buy</button>
                  <button class="btn sell" onclick="placeTrade('sell')">Place Sell</button>
                </div>
              </div>

              <div style="margin-top:12px">
                <h4 style="margin:0;color:var(--accent)">Account</h4>
                <div class="xs muted" style="margin-top:8px">Balance</div>
                <div id="accBalance" style="font-weight:900">KES 10,000</div>
                <div class="xs muted" style="margin-top:8px">Open P/L</div>
                <div id="accPL">KES 0</div>

                <div style="margin-top:10px;display:flex;gap:8px">
                  <button class="btn" onclick="depositDialog()">Deposit</button>
                  <button class="btn ghost" onclick="resetDemo()">Reset</button>
                </div>
              </div>

              <div style="margin-top:12px">
                <h4 style="margin:0">Recent</h4>
                <div id="recentList" class="orders"></div>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="btn ghost" onclick="exportHistory()">Export</button>
                </div>
              </div>
            </div>
          </aside>
        </div>
      </div>

      <div id="payments" class="panel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="color:var(--accent);margin:0">Payments & Deposit</h2>
            <div class="muted xs">Preferred: M-Pesa Till (demo)</div>
          </div>
          <div>
            <button class="btn" onclick="copyTill()">Copy Till</button>
            <button class="btn ghost" onclick="openWhats()">Verify</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <div style="flex:1">
              <div class="muted">Till Number</div>
              <div style="font-weight:900;color:var(--accent);font-size:20px">3675058</div>
              <div class="pay-note">After payment, send transaction ID via WhatsApp for verification (demo flow).</div>
            </div>
            <div class="pay-icons">
              <div class="pay-icon"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6d/M-PESA_LOGO-01.svg" alt="M-Pesa" style="width:100%"/></div>
              <div class="pay-icon"><img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" style="width:100%"/></div>
              <div class="pay-icon"><img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg" alt="Visa" style="width:100%"/></div>
              <div class="pay-icon"><img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Mastercard-logo.png" alt="MC" style="width:100%"/></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4 style="color:var(--accent);margin:0">How to verify (demo)</h4>
          <ol class="muted xs" style="margin-top:8px">
            <li>Send payment to Till <strong>3675058</strong>.</li>
            <li>Open WhatsApp and send the transaction ID to support.</li>
            <li>We will (demo) confirm and credit your demo account when you press "Simulate Verify".</li>
          </ol>
          <div style="margin-top:10px">
            <button class="btn" onclick="simulateVerify()">Simulate Verify</button>
          </div>
        </div>
      </div>

      <footer><div class="muted xs">© <span id="year"></span> Deriv_Trade — Demo environment (local only)</div></footer>
    </main>

  </div>

  <!-- alerts -->
  <div class="alerts" id="alerts"></div>

<script>
/* ===============================
   Simple Auth (Option 1 behavior)
   - users stored under 'dt_users'
   - session stored under 'dt_session'
   =============================== */
const USERS_KEY = 'dt_users_v1';
const SESSION_KEY = 'dt_session_v1';
const DEMO_STATE_KEY = 'dt_demo_state_v1';

function getUsers(){ return JSON.parse(localStorage.getItem(USERS_KEY) || '{}'); }
function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
function getSession(){ return JSON.parse(localStorage.getItem(SESSION_KEY) || 'null'); }
function setSession(username){ localStorage.setItem(SESSION_KEY, JSON.stringify({ username, ts: Date.now() })); }
function clearSession(){ localStorage.removeItem(SESSION_KEY); }

/* ===== Demo state structure ===== */
let demoState = JSON.parse(localStorage.getItem(DEMO_STATE_KEY) || JSON.stringify({
  balance: 10000,
  orders: [], // pending positions and open positions
  history: [] // closed
}));

function saveDemo(){ localStorage.setItem(DEMO_STATE_KEY, JSON.stringify(demoState)); updateAccountUI(); renderOrders(); renderRecent(); }

/* ===== UI building: auth area (login/register) ===== */
const authArea = document.getElementById('authArea');
const appArea = document.getElementById('appArea');
const welcomeUser = document.getElementById('welcomeUser');
const logoutBtn = document.getElementById('logoutBtn');

function buildAuthUI(){
  authArea.innerHTML = `
    <div class="auth-wrap">
      <div class="auth-left panel">
        <h2 style="color:var(--accent);margin:0">Welcome to Deriv_Trade</h2>
        <p class="muted xs" style="margin-top:8px">Sign in or create a quick account to access demo trading.</p>
        <div style="margin-top:12px" class="auth-note">
          <div><strong>Demo Notice</strong></div>
          <div class="xs muted" style="margin-top:6px">Accounts and demo data are stored locally in your browser (no backend). Quick Demo will create a sample user.</div>
        </div>
      </div>

      <div class="auth-right card">
        <div class="tab">
          <button id="tabLogin" class="tabbtn active">Login</button>
          <button id="tabReg" class="tabbtn">Register</button>
        </div>

        <div id="loginPanel">
          <div style="margin-bottom:8px"><input id="loginUser" class="input" placeholder="Username (e.g. paul123)"></div>
          <div style="margin-bottom:8px"><input id="loginPass" type="password" class="input" placeholder="Password"></div>
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="doLogin()">Login</button>
            <button class="btn ghost" onclick="quickDemo()">Quick Demo</button>
          </div>
          <div id="loginMsg" class="xs muted" style="margin-top:8px"></div>
        </div>

        <div id="regPanel" style="display:none">
          <div style="margin-bottom:8px"><input id="regUser" class="input" placeholder="Choose username"></div>
          <div style="margin-bottom:8px"><input id="regPass" type="password" class="input" placeholder="Password"></div>
          <div style="margin-bottom:8px"><input id="regPass2" type="password" class="input" placeholder="Confirm password"></div>
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="doRegister()">Create Account</button>
            <button class="btn ghost" onclick="fillSample()">Autofill</button>
          </div>
          <div id="regMsg" class="xs muted" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  `;

  // hookup
  document.getElementById('tabLogin').onclick = ()=>{ showLogin(); };
  document.getElementById('tabReg').onclick = ()=>{ showReg(); };
}

function showLogin(){ document.getElementById('loginPanel').style.display='block'; document.getElementById('regPanel').style.display='none'; document.getElementById('tabLogin').classList.add('active'); document.getElementById('tabReg').classList.remove('active'); }
function showReg(){ document.getElementById('loginPanel').style.display='none'; document.getElementById('regPanel').style.display='block'; document.getElementById('tabReg').classList.add('active'); document.getElementById('tabLogin').classList.remove('active'); }

/* ===== Auth actions ===== */
function doRegister(){
  const u = document.getElementById('regUser').value.trim();
  const p = document.getElementById('regPass').value;
  const p2 = document.getElementById('regPass2').value;
  const msg = document.getElementById('regMsg');
  msg.innerText = '';
  if(!u || !p || !p2){ msg.innerText = 'Fill all fields'; return; }
  if(p !== p2){ msg.innerText = 'Passwords do not match'; return; }
  const users = getUsers();
  if(users[u]){ msg.innerText = 'Username taken'; return; }
  users[u] = { pass: p, created: Date.now() };
  saveUsers(users);
  setSession(u);
  msg.innerText = 'Account created — redirecting...';
  setTimeout(()=> initApp(), 700);
}

function doLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  const msg = document.getElementById('loginMsg');
  msg.innerText = '';
  if(!u || !p){ msg.innerText = 'Enter username and password'; return; }
  const users = getUsers();
  if(!users[u] || users[u].pass !== p){ msg.innerText = 'Invalid credentials'; return; }
  setSession(u);
  msg.innerText = 'Login successful — redirecting...';
  setTimeout(()=> initApp(), 500);
}

function quickDemo(){
  const users = getUsers();
  users['demo_user'] = { pass: 'demo123', created: Date.now() };
  saveUsers(users);
  setSession('demo_user');
  initApp();
}

function fillSample(){
  document.getElementById('regUser').value = 'user'+Math.floor(Math.random()*900);
  document.getElementById('regPass').value = 'pass123';
  document.getElementById('regPass2').value = 'pass123';
}

/* ===== App initialization ===== */
function initApp(){
  // Hide auth, show app
  authArea.style.display = 'none';
  appArea.style.display = 'block';
  const s = getSession();
  if(s && s.username){
    welcomeUser.innerText = 'Hi, ' + s.username;
    logoutBtn.style.display = 'inline-block';
  } else {
    welcomeUser.innerText = '';
    logoutBtn.style.display = 'none';
  }
  // default show home
  showPage('home');
  updateAccountUI();
}

/* If session exists on load, initialize app, else show auth */
(function onLoad(){
  buildAuthUI();
  const s = getSession();
  if(s && s.username){ initApp(); } else { authArea.style.display = 'block'; appArea.style.display = 'none'; }
})();

/* ===== Logout ===== */
function logout(){
  clearSession();
  // resume auth UI
  authArea.style.display = 'block';
  appArea.style.display = 'none';
  welcomeUser.innerText = '';
  logoutBtn.style.display = 'none';
  showAlert('Logged out', 'info');
}

/* ===== Page switching (instant tabs) ===== */
function showPage(page){
  // hide auth area if any
  authArea.style.display = 'none';
  appArea.style.display = 'block';
  // hide sections
  ['home','trade','payments'].forEach(p=>{ const el = document.getElementById(p); if(el) el.style.display='none'; });
  // show requested
  const el = document.getElementById(page);
  if(el) el.style.display = 'block';
  // set active tab styling
  document.querySelectorAll('.tabbtn').forEach(b=>{ b.classList.toggle('active', b.dataset.page===page); });
  // ensure user is logged in if trying to see protected pages
  const s = getSession();
  if(!s && page !== 'home'){
    // show auth if not logged
    authArea.style.display = 'block';
    appArea.style.display = 'none';
    showAlert('Please login to access this page', 'error');
    return;
  }
}

/* ===== Alerts ===== */
function showAlert(text, type='info', timeout=4500){
  const wrap = document.getElementById('alerts');
  const el = document.createElement('div'); el.className = 'alert';
  el.innerHTML = `<div style="font-weight:800">${text}</div><div class="muted xs">${type}</div>`;
  wrap.appendChild(el);
  setTimeout(()=> el.remove(), timeout);
}

/* ===========================
   Demo trading engine (front-end)
   - demoState tracks balance, orders, history
   - orders array contains pending & open positions
   - pending orders execute after 8s (simulated)
   =========================== */
const ASSETS = {
  EURUSD:{ symbol:'EUR/USD', base:1.0864, spread:0.8, type:'forex' },
  GBPUSD:{ symbol:'GBP/USD', base:1.2741, spread:1.0, type:'forex' },
  BTCUSD:{ symbol:'BTC/USD', base:37850, spread:50, type:'crypto' },
  XAUUSD:{ symbol:'XAU/USD', base:1840.30, spread:1.8, type:'commodity' },
  USDJPY:{ symbol:'USD/JPY', base:147.82, spread:2, type:'forex' }
};
let currentAsset = 'EURUSD';

/* Chart.js setup */
const ctx = document.getElementById('chartCanvas').getContext('2d');
let labels = [], chartData = [];
for(let i=30;i>=0;i--){ labels.push(new Date(Date.now()-i*60000).toLocaleTimeString().slice(0,5)); chartData.push(ASSETS[currentAsset].base); }
const chart = new Chart(ctx, {
  type:'line',
  data:{ labels, datasets:[{ data: chartData, borderColor:'rgba(227,6,19,0.95)', backgroundColor:'rgba(227,6,19,0.06)', tension:0.25, pointRadius:0 }] },
  options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ display:true }, y:{ display:true } } }
});

/* Push simulated points */
setInterval(()=>{
  // small movement on all assets
  Object.keys(ASSETS).forEach(k=>{
    const a = ASSETS[k];
    const vol = a.type === 'crypto' ? 0.02 : 0.0025;
    a.base = +(a.base * (1 + (Math.random()-0.5)*vol)).toFixed(a.type === 'crypto' ? 0 : 4);
  });
  // update chart with current asset's base
  const next = ASSETS[currentAsset].base;
  chart.data.labels.push(new Date().toLocaleTimeString().slice(0,5));
  chart.data.datasets[0].data.push(next);
  if(chart.data.labels.length>60){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
  chart.update();
  evaluateOpenPnl(); renderOrders(); renderRecent(); updateAccountUI();
}, 3500);

/* Utility format */
function formatPrice(v,k){ if(k==='BTCUSD'||k==='XAUUSD') return '$' + Number(v).toLocaleString(); if(k==='USDJPY') return v.toFixed(2); return v.toFixed(4); }

/* Change asset */
function changeAsset(val){
  currentAsset = val;
  document.getElementById('assetTitle').innerText = ASSETS[val].symbol;
  document.getElementById('panelAsset').innerText = ASSETS[val].symbol;
  document.getElementById('spread').innerText = ASSETS[val].spread;
  // adjust chart base quick reset
  chart.data.datasets[0].data = chart.data.datasets[0].data.map(()=>ASSETS[val].base);
  chart.update();
  showAlert('Switched to ' + ASSETS[val].symbol, 'info');
}

/* Demo order lifecycle */
function quickOrder(side){
  const size = parseFloat(document.getElementById('tradeSize').value) || 1;
  const lev = parseInt(document.getElementById('tradeLev').value) || 50;
  createPending(side, size, lev);
}
function placeTrade(side){
  const size = parseFloat(document.getElementById('panelSize').value) || 1;
  const lev = parseInt(document.getElementById('panelLev').value) || 50;
  createPending(side, size, lev);
}

function createPending(side,size,lev){
  const entry = ASSETS[currentAsset].base;
  // simplistic margin calculation
  const margin = Math.max(50, Math.round((size * (currentAsset==='BTCUSD' ? entry/100 : entry)) / lev));
  if(demoState.balance < margin){ showAlert('Insufficient demo balance for margin KES ' + margin, 'error'); return; }
  demoState.balance -= margin;
  const pending = { id:'p'+Date.now(), side, symbol: currentAsset, size, lev, entry, margin, status:'pending', countdown:8, created:Date.now() };
  demoState.orders.push(pending);
  saveDemo();
  showAlert(`${side.toUpperCase()} pending — will execute in ~8s`, 'info');
  // start countdown
  const intId = setInterval(()=>{
    pending.countdown--;
    if(pending.countdown<=0){
      clearInterval(intId);
      executePending(pending.id);
    }
    saveDemo();
  },1000);
}

function executePending(id){
  const idx = demoState.orders.findIndex(o=>o.id===id && o.status==='pending');
  if(idx === -1) return;
  const p = demoState.orders[idx];
  const slippage = (Math.random()-0.5)*0.0004; // small slippage
  const execPrice = +(ASSETS[p.symbol].base * (1 + slippage)).toFixed(p.symbol==='BTCUSD'?0:4);
  const position = { id:'pos'+Date.now(), side:p.side, symbol:p.symbol, size:p.size, lev:p.lev, entry:execPrice, margin:p.margin, status:'open', openedAt:new Date().toLocaleTimeString(), pnl:0 };
  // replace pending with position
  demoState.orders.splice(idx,1);
  demoState.orders.push(position);
  saveDemo();
  showAlert(`${position.side.toUpperCase()} executed @ ${position.entry}`, 'success');
  renderOrders(); renderRecent(); updateAccountUI();
}

function evaluateOpenPnl(){
  let total = 0;
  demoState.orders.forEach(o=>{
    if(o.status !== 'open') return;
    const current = ASSETS[o.symbol].base;
    const sign = o.side==='buy'?1:-1;
    const pnl = Math.round((current - o.entry) * o.size * 1000 * sign); // simplified
    o.pnl = pnl;
    total += pnl;
  });
  // show in UI
  document.getElementById('accPL').innerText = 'KES ' + Math.round(total);
  document.getElementById('accBalance').innerText = 'KES ' + Math.round(demoState.balance);
}

function closeAll(){
  if(demoState.orders.length === 0){ showAlert('No positions', 'info'); return; }
  let realized = 0;
  const remaining = [];
  demoState.orders.forEach(o=>{
    if(o.status === 'open'){
      realized += o.pnl || 0;
      demoState.balance += o.margin + (o.pnl || 0);
      demoState.history.push({ side:o.side, symbol:o.symbol, size:o.size, pnl:o.pnl, closedAt:new Date().toLocaleString() });
    } else if(o.status === 'pending'){
      // cancel pending and refund
      demoState.balance += o.margin;
      demoState.history.push({ side:o.side, symbol:o.symbol, remark:'pending cancelled', closedAt:new Date().toLocaleTimeString() });
    }
  });
  demoState.orders = remaining;
  saveDemo();
  showAlert('All positions closed. Realized KES ' + realized, 'success');
}

/* Render orders & recent */
function renderOrders(){
  const el = document.getElementById('ordersList'); el.innerHTML = '';
  if(demoState.orders.length === 0){ el.innerHTML = '<div class="muted xs">No open positions or pending</div>'; return; }
  // show newest first
  demoState.orders.slice().reverse().forEach(o=>{
    const div = document.createElement('div'); div.className = 'order';
    if(o.status === 'pending'){
      div.innerHTML = `<div><strong>${o.side.toUpperCase()} (pending)</strong><div class="muted xs">Asset: ${ASSETS[o.symbol].symbol} • Size ${o.size} • Margin KES ${o.margin}</div></div><div style="text-align:right"><div class="muted xs">Exec in ${o.countdown}s</div></div>`;
    } else {
      div.innerHTML = `<div><strong>${o.side.toUpperCase()}</strong><div class="muted xs">Entry: ${o.entry} • Size ${o.size}</div></div><div style="text-align:right"><div style="font-weight:800">${o.pnl? 'KES '+o.pnl : 'KES 0'}</div><div class="muted xs">${o.openedAt||''}</div></div>`;
    }
    el.appendChild(div);
  });
}

function renderRecent(){
  const el = document.getElementById('recentList'); el.innerHTML = '';
  if(!demoState.history.length){ el.innerHTML = '<div class="muted xs">No history yet</div>'; return; }
  demoState.history.slice().reverse().slice(0,8).forEach(h=>{
    const d = document.createElement('div'); d.className='order';
    d.innerHTML = `<div><strong>${h.side||''} ${h.symbol||''}</strong><div class="muted xs">${h.closedAt||''}</div></div><div style="text-align:right"><div class="muted xs">${h.pnl? 'KES '+h.pnl : (h.remark||'')}</div></div>`;
    el.appendChild(d);
  });
}

/* Deposit & verify (demo) */
function depositDialog(){
  const v = parseFloat(prompt('Enter deposit amount (KES)', '1000'));
  if(!v || isNaN(v) || v<=0) { showAlert('Invalid amount', 'error'); return; }
  demoState.balance += v; saveDemo();
  showAlert('Demo deposit KES ' + v, 'success');
}

function simulateVerify(){
  // For demo: credit fixed amount
  const v = parseFloat(prompt('Enter amount to credit after verification (KES)', '1000'));
  if(!v || isNaN(v) || v<=0) return;
  demoState.balance += v; saveDemo();
  showAlert('Verified — credited KES ' + v, 'success');
}

/* Payments helpers */
function copyTill(){ navigator.clipboard?.writeText('3675058'); showAlert('Till 3675058 copied', 'info'); }
function openWhats(){ window.open('https://wa.me/254796518099', '_blank'); }

/* Export history */
function exportHistory(){
  const blob = new Blob([JSON.stringify(demoState, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'deriv_trade_demo_history.json'; a.click(); URL.revokeObjectURL(url);
  showAlert('Export ready', 'info');
}

/* Save & update UI */
function saveAndRender(){ localStorage.setItem(DEMO_STATE_KEY, JSON.stringify(demoState)); updateAccountUI(); renderOrders(); renderRecent(); }
function updateAccountUI(){
  document.getElementById('accBalance').innerText = 'KES ' + Math.round(demoState.balance);
  document.getElementById('panelAsset').innerText = ASSETS[currentAsset].symbol;
  document.getElementById('assetTitle').innerText = ASSETS[currentAsset].symbol;
  document.getElementById('spread').innerText = ASSETS[currentAsset].spread;
  document.getElementById('welcomeUser').innerText = (getSession() && getSession().username) ? 'Hi, ' + getSession().username : '';
  logoutBtn.style.display = getSession() ? 'inline-block' : 'none';
}

/* Save demo state initially */
saveDemo();

/* Helper functions used earlier */
function getUsers(){ return JSON.parse(localStorage.getItem(USERS_KEY) || '{}'); }
function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
function getSession(){ return JSON.parse(localStorage.getItem(SESSION_KEY) || 'null'); }
function setSession(u){ localStorage.setItem(SESSION_KEY, JSON.stringify({ username:u, ts: Date.now() })); }
function clearSession(){ localStorage.removeItem(SESSION_KEY); }

/* For compatibility with earlier functions used in UI */
function saveDemoState(){ saveDemo(); }
function resetDemo(){ if(confirm('Reset demo data?')){ demoState = { balance:10000, orders:[], history:[] }; saveDemo(); showAlert('Demo reset', 'info'); } }

// Expose some functions to buttons globally
window.showPage = showPage;
window.logout = logout;
window.depositDialog = depositDialog;
window.exportHistory = exportHistory;
window.resetDemo = resetDemo;
window.copyTill = copyTill;
window.openWhats = openWhats;
window.simulateVerify = simulateVerify;
window.quickOrder = quickOrder;
window.placeTrade = placeTrade;
window.quickDemo = quickDemo;

/* Set year in footer */
document.getElementById('year').innerText = new Date().getFullYear();

/* If user is logged in by the time page loads, init app */
if(getSession()){ initApp(); } else { /* show auth */ }

/* initial render for orders/recent */
renderOrders(); renderRecent(); updateAccountUI();

</script>
</body>
  </html>
